#include <tunables/global>

profile upload-file-profile flags=(attach_disconnected, mediate_deleted) {

  # Baselines
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Networking (no raw)
  network inet stream,
  network inet dgram,
  deny network raw,

  # Minimal caps (port 27465 > 1024; no net_bind_service needed)
  capability setuid,
  capability setgid,

  # Devices
  /dev/null        rw,
  /dev/zero        r,
  /dev/urandom     r,
  /dev/random      r,

  # socat
  /dev/tty         rw,
  /dev/pts/ptmx	   rw,
  /dev/pts/0	   rw,

  # ===== EXEC allowlist (what the image actually runs) =====
  /usr/local/bin/docker-php-entrypoint  mrix,
  /usr/local/bin/apache2-foreground     mrix,
  /usr/sbin/apache2                     mrix,
  /usr/sbin/apache2ctl                  mrix,
  /bin/sh                               mrix,
  /bin/dash                             mrix,
  /bin/bash                             mrix,
  /usr/bin/env                          mrix,
  /usr/bin/dirname			mrix,
  /usr/bin/mkdir			mrix,

  # Allowed apache2-foreground and user commands
  /usr/bin/**  				mrix,
  /bin/**      				mrix,
  /usr/sbin/** 				mrix,

  # Python related
  /usr/bin/python3			rix,
  /usr/local/lib/python3.13/**          mr,
  /usr/lib/python3.*/**			mr,
  /usr/local/etc/php/conf.d/** 		r,
  /usr/local/etc/php/conf.d/		r
  /usr/local/etc/php/conf/		r,
  /usr/local/lib/**			mr,

  # Shell related
  /usr/share/terminfo/**		r,

  # System libs/config
  /lib/**                  mr,
  /lib64/**                mr,
  /usr/lib/**              mr,
  /usr/lib/apache2/**      mr,
  /etc/**                  r,
  /etc/apache2/**          r,
  /etc/apache2/.htpasswd   r,

  /usr/local/etc/php/conf.d/**   r,
  network netlink raw,
  signal,

  # Website folder permissions
  /var/www/html/           r,
  /var/www/html/**         r,
  /home/**		   r,
  /home/		   r,
  /home/user1/hint.txt	   r,
  /home/user1/**           r,
  /home/user1/vuln-64 		 mrix,
  /home/user1/exploit-64.py    	 mrix,

  # Writable app dirs
  /var/www/html/uploads/    rwk,
  /var/www/html/uploads/**  rwk,
  /var/www/html/logs/       rwk,
  /var/www/html/logs/**     rwk,

  # Runtime + logging (include 'l' so ln can create symlinks to stdout/stderr)
  /run/apache2/**           rwkl,
  /var/log/apache2/         rwkl,
  /var/log/apache2/**       rwkl,
  /tmp/**                   rwk,



  # Proc (for /proc/self/fd symlink targets and general reads)
  /proc/**                  r,
}

